# HNX 系统库 (HNX System Library)

`hnxlib` 模块 (`space/hnxlib`) 是 HNX 操作系统用户空间的核心库。它为所有用户空间服务和应用程序提供了一套高级 API，用于与内核进行交互、执行系统调用、以及实现进程间通信 (IPC)。`hnxlib` 旨在简化 HNX 上的应用开发，将底层复杂的系统接口抽象为易于使用的 Rust 函数。

## 设计目标

-   **简化系统交互:** 将直接的系统调用封装为更安全、更符合 Rust 习惯的函数接口。
-   **IPC 客户端:** 提供用于构建和发送 IPC 消息、接收响应的工具，从而实现服务之间的通信。
-   **平台抽象:** 在一定程度上抽象了底层架构的细节，为用户空间程序提供相对一致的编程环境。
-   **错误处理:** 提供统一的错误类型和处理机制，简化用户空间程序的错误管理。

## 核心组件

`hnxlib` 包含以下关键子模块：

### `lib.rs` (主模块)

`hnxlib` 的主模块，负责导出所有公共 API 和子模块。它通常会包含一些通用的实用函数和类型定义，以及对整个库进行初始化或配置的逻辑。

### `ipc.rs` (进程间通信)

这是 `hnxlib` 中最重要的模块之一，它为用户空间提供了与内核和其他服务进行 IPC 的接口。

-   **`ServiceFramework`:** HNX 服务开发的核心框架。它提供了一种标准化的方式来创建和运行用户空间服务。服务通过实现 `ServiceFramework` 定义的 trait，可以自动处理服务注册、发现、消息接收和分发等。
-   **`Endpoint`:** 代表一个 IPC 通信的端点。服务可以通过 `Endpoint` 来发送和接收消息。
-   **消息与协议:** 定义了 IPC 消息的结构 (`IpcMessage`) 和处理这些消息的协议，确保了用户空间与内核之间以及服务之间的通信是类型安全和可预测的。

### `safe_syscall.rs` (安全系统调用封装)

该模块封装了底层的 HNX 系统调用。它提供了一层抽象，将原始的系统调用接口转换为更安全、更符合 Rust 类型系统规则的函数。通过 `safe_syscall.rs`，用户程序可以调用内核提供的服务（如内存分配、进程控制、文件操作等），而无需直接处理汇编或原始系统调用编号。

-   **功能:** 提供了 `sys_write` (控制台输出)、`sys_spawn_service` (启动服务)、`sys_ipc_wait` (等待 IPC 消息) 等系统调用的安全封装。
-   **错误处理:** 将内核返回的错误码转换为 `hnxlib` 定义的错误类型，方便用户程序进行处理。

### `arch/` (架构特定辅助函数)

`hnxlib/src/arch` 目录可能包含少量的架构特定辅助函数或常量。这些函数在用户空间层面提供了对特定架构特性的轻量级封装，例如与 CPU 寄存器相关的操作或内存屏障。

## 使用方式

用户空间的服务和应用程序通常会通过 `hnxlib` 来实现其功能。例如：

-   一个服务会使用 `hnxlib::ipc::ServiceFramework` 来启动并接收来自其他服务的请求。
-   一个应用程序会调用 `hnxlib::safe_syscall` 中的函数来执行文件操作或进程控制。

`hnxlib` 使得 HNX 上的用户空间开发变得更加高效和安全，是 HNX 微内核生态系统中不可或缺的一部分。