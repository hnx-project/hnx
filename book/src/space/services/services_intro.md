# 系统服务 (System Services)

HNX 操作系统的大部分核心功能都以独立的用户空间服务 (System Services) 的形式运行，位于 `space/services` 目录下。这种微内核架构将传统的内核功能分解为更小、更独立的组件，通过 IPC（进程间通信）机制相互协作，共同提供完整的系统服务。这极大地增强了系统的模块化、可扩展性和容错能力。

## 服务架构设计

-   **独立进程:** 每个服务都是一个独立的用户空间进程，拥有自己的地址空间和资源，相互之间通过 IPC 进行通信。
-   **基于 IPC:** 服务之间以及服务与内核之间通过统一的 IPC 机制传递消息和请求。HNX 提供了类型安全的 IPC 抽象，简化了通信过程。
-   **服务注册与发现:** 通过 IPC Router 服务实现服务的动态注册与发现，使得服务可以灵活地加入和离开系统。
-   **高可用性:** 服务的独立性意味着单个服务的崩溃不会影响整个系统的稳定性，内核可以重启故障服务，提高系统的鲁棒性。

## 服务开发规范

为了保持服务间的一致性和互操作性，HNX 强制执行以下服务开发规范（详细指南请参考 `space/services/SERVICE_DEVELOPMENT.md`）：

-   **服务命名:** 所有系统服务都必须使用 `-service` 后缀（例如 `ipcrouter-service`, `loader-service`）。
-   **服务框架:** 推荐使用 `hnxlib::ipc::ServiceFramework` 来简化服务开发。该框架提供了自动的服务注册、消息分发和 IPC 消息处理功能。
-   **IPC 通信:** 使用 HNX 提供的类型安全的 `Endpoint` 抽象进行进程间通信，确保消息的正确性和安全性。
-   **错误处理:** 服务在处理请求时应返回统一的 `IpcError` 错误类型，以便调用者能够清晰地识别和处理错误。

## 核心系统服务

`space/services` 目录中包含了 HNX 的主要系统服务：

-   **`init/` (初始化进程 - PID 1):**
    -   作为用户空间的第一个进程，由内核启动。
    -   负责初始化用户空间环境，并启动所有其他核心系统服务。
    -   监控其他服务的运行状态，并在必要时进行重启。

-   **`loader-service/` (服务加载器):**
    -   负责加载和管理用户空间的可执行程序和库。
    -   当新的应用程序或服务需要启动时，内核会委托 `loader-service` 来完成 ELF 文件的解析、内存映射和进程上下文的设置。

-   **`vfs-service/` (虚拟文件系统服务):**
    -   提供统一的文件系统抽象层，管理文件和目录的创建、读写以及权限控制。
    -   它将底层不同的存储设备（如 Ramdisk, 块设备）统一抽象，提供 POSIX 兼容的文件操作接口。

-   **`ipcrouter-service/` (IPC 路由服务):**
    -   作为所有用户空间 IPC 通信的中央枢纽。
    -   提供服务注册和发现功能，允许服务动态地向系统注册其 IPC 端点，并允许其他服务发现并连接到它们。
    -   负责 IPC 消息的转发和路由。

-   **`procmgr-service/` (进程管理服务):**
    -   负责用户空间进程的生命周期管理。
    -   提供进程创建、销毁、暂停、恢复以及获取进程信息等功能。
    -   与内核的 `process` 模块协同工作，但处理的是用户空间层面的进程管理逻辑。

-   **`echo-service/` (回显测试服务):**
    -   一个简单的示例服务，用于演示 HNX 的 IPC 通信机制。
    -   接收消息并原样返回，是调试和测试 IPC 基础设施的良好范例。

-   **`device-driver-server/` (设备驱动服务):**
    -   旨在将设备驱动从内核空间迁移到用户空间，以提高安全性和稳定性。
    -   每个设备驱动可能作为一个独立的服务运行，通过 IPC 与其他服务和应用程序交互。

-   **`filesystem-server/` (文件系统服务):**
    -   类似于 `vfs-service`，但可能专注于处理特定的文件系统类型（如 Ext4, FAT）。
    -   与 `vfs-service` 配合，提供对各种文件系统的支持。

-   **`network-server/` (网络服务):**
    -   负责实现网络协议栈（如 TCP/IP）。
    -   管理网络接口设备，提供网络连接和数据传输服务。

这些服务通过 `hnxlib` 提供的 API 和 `shared` 库中的类型定义来构建和通信，共同构成了 HNX 强大而灵活的用户空间环境。