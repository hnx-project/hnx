# 架构抽象层 (Architecture Abstraction Layer)

HNX 内核的架构抽象层 (Arch Layer) 位于 `kernel/src/arch` 目录，其核心目标是实现内核的跨平台兼容性。通过提供一套统一的接口，它将硬件相关的底层操作与内核的通用逻辑分离，使得 HNX 能够支持不同的处理器架构，如当前的 AArch64 以及未来可能支持的 x86_64 和 RISC-V。

## 结构与设计

架构抽象层遵循严格的约定，以确保通用代码和架构特定代码之间的清晰分离：

1.  **通用接口 (Traits):** 内核的通用部分通过 Rust 的 `trait` 定义一套抽象接口，例如内存管理单元 (MMU) 操作、中断处理、上下文切换、系统调用入口等。所有架构特定的实现都必须实现这些 `trait`。

2.  **架构特定实现:** 每个受支持的处理器架构都在 `kernel/src/arch` 目录下拥有独立的子目录，例如 `aarch64`。这些子目录包含了该架构的特定实现代码，负责将通用接口映射到具体的硬件指令和寄存器操作。

    -   `aarch64/`: 包含针对 AArch64 架构的实现，包括：
        -   **中断处理 (`interrupt.rs`):** 处理来自硬件的中断和异常。
        -   **内存管理单元 (`mmu.rs`):** 配置和管理 AArch64 的 MMU，进行物理地址到虚拟地址的转换。
        -   **启动代码 (`boot.rs`):** AArch64 特定的内核启动流程和初始化。
        -   **汇编代码:** 通常包含底层的汇编语言例程，用于上下文切换、异常向量表等。

3.  **跨架构通用代码 (`common/`):** 包含可在所有架构之间共享的代码，例如一些通用的宏定义、数据结构或辅助函数，这些代码本身不依赖于特定的硬件特性。

## 关键功能

-   **引导启动 (Bootstrapping):** 管理内核在特定硬件平台上的初始化过程，包括设置初始页表、初始化中断控制器、切换到 EL1/EL0 模式等。
-   **内存管理单元 (MMU) 控制:** 提供对硬件 MMU 的编程接口，实现虚拟内存的映射、权限控制和地址空间切换。
-   **中断与异常处理:** 设置中断向量表，定义中断和异常的入口点，并提供处理这些事件的机制。
-   **上下文切换 (Context Switching):** 实现进程或线程之间 CPU 状态的保存和恢复，这是任务调度的基础。
-   **系统调用接口 (Syscall Interface):** 定义用户空间如何通过架构特定的机制（如 SVC 指令）进入内核，并触发相应的系统调用处理程序。
-   **定时器管理:** 硬件定时器的初始化和配置，为内核的调度器和时间相关服务提供精确的时间源。

## 设计目标与挑战

-   **可移植性:** 最大化通用代码，最小化架构特定代码，简化对新架构的支持。
-   **性能:** 确保底层硬件操作的高效性，避免不必要的抽象开销。
-   **安全性:** 严格控制对底层硬件的访问，防止用户空间或恶意代码直接操纵硬件。
-   **复杂性管理:** 平衡抽象层和硬件细节之间的关系，使得代码既易于理解又功能强大。

通过这种分层设计，HNX 能够在保持内核精简的同时，有效地管理不同硬件平台的复杂性，为上层服务提供稳定、一致的运行环境。