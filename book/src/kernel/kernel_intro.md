# HNX 微内核架构

HNX 采用分层微内核设计，旨在实现安全性、模块化和可移植性。其核心思想是将操作系统的功能尽可能地从内核空间移到用户空间，使得内核本身尽可能小而可靠。

## 内核架构图

以下是 HNX 内核与用户空间服务交互的简化架构图：

```text
+------------------------------------------------------+
|                      用户空间 (User Space)             |
|                                                      |
|  +------------+   +-------------+   +-------------+  |
|  | Init (PID 1)|   | loader-serv |   |  vfs-serv   |  |
|  +------------+   +-------------+   +-------------+  |
|        ^                ^                 ^          |
|        |      IPC (Inter-Process Communication)     |
+--------|----------------|-----------------|----------+
         |   System Call  |   System Call   |
+--------V----------------V-----------------V----------+
|                      内核空间 (Kernel Space)           |
|                                                      |
|  +------------------------------------------------+  |
|  |                     核心模块 (Core)              |  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  |  | IPC 管理  |  | 调度器    |  | 内存管理  |  |  |
|  |  | (IPC Mgr) |  | (Scheduler) |  | (Memory Mgr)|  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  +------------------------------------------------+  |
|  |                 架构特定代码 (Arch)            |  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  |  | AArch64   |  | MMU       |  | 中断 (IRQ)|  |  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  +------------------------------------------------+  |
|  |                     驱动程序 (Drivers)           |  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  |  | UART      |  | GIC       |  | DTB       |  |  |
|  |  +-----------+  +-----------+  +-----------+  |  |
|  +------------------------------------------------+  |
|                                                      |
+------------------------------------------------------+
```

- **用户空间 (User Space):** 包含所有系统服务和应用程序。它们作为独立的进程运行，并通过 IPC 与内核和其他服务通信。
- **内核空间 (Kernel Space):** 提供最基本的服务，包括进程间通信（IPC）、调度、内存管理和硬件抽象。

## 当前开发进度 (版本: 0.3.0-alpha.1)

### 已实现的核心功能
- **微内核:** 具备基本调度功能。
- **虚拟内存:** 每个进程拥有独立的页表，实现了用户/内核空间分离。
- **IPC 框架:** 具备超时机制的 IPC 通信基础设施。
- **服务加载:** 支持从 initrd 加载和启动用户空间服务。
- **控制台输出:** 通过 `sys_write` 系统调用实现。
- **服务开发框架:** 提供统一的 `ServiceFramework`，简化服务开发。
- **类型安全的 IPC:** 提供 `Endpoint` 抽象，确保 IPC 通信的类型安全。
- **服务发现:** 实现基本的服务注册与发现机制。

### 正在进行的工作
- 修复系统调用返回值传递问题。
- 将现有服务适配到新的 IPC 框架。
- 完善进程管理服务的功能。
- 为内核增加 initrd 的 gzip 解压支持。

## 内核组件概览 (Kernel Components Overview)

HNX 内核由以下关键组件构成，它们协同工作以提供一个稳定、安全且高效的操作系统基础：

- **架构抽象层 (Architecture Abstraction):** 位于 `kernel/src/arch` 目录，提供了针对不同处理器架构（如 AArch64）的底层硬件接口和通用抽象层。这包括内存管理单元 (MMU) 的配置、中断处理、启动序列等，确保内核在不同硬件平台上具备可移植性。

- **核心原语 (Core Primitives):** 位于 `kernel/src/core` 目录，包含了内核最基础的服务，如进程间通信 (IPC) 机制和调度器。IPC 负责内核与用户空间服务以及服务之间的通信；调度器则管理进程和线程的执行，实现任务切换和资源分配。

- **驱动程序 (Drivers):** 位于 `kernel/src/drivers` 目录，包含了与特定硬件设备交互的代码，例如 UART (通用异步收发传输器)、GIC (通用中断控制器) 和 DTB (设备树二进制) 解析器。这些驱动程序为内核提供访问和控制硬件的能力。

- **错误处理 (Error Handling):** 位于 `kernel/src/error` 目录，定义了内核的错误类型和处理机制。它确保在系统出现异常或错误时，能够进行统一、可控的错误报告和恢复。

- **IPC 服务 (IPC Services):** 位于 `kernel/src/ipc_services` 目录，实现了内核层面的 IPC 服务代理和协议。这些服务负责处理来自用户空间的系统调用请求，并可能将复杂操作委托给用户空间的服务进行处理。

- **加载器 (Loader):** 位于 `kernel/src/loader` 目录，负责内核的引导加载和用户空间服务的启动。特别是 `initrd.rs` 管理着初始根文件系统 (initrd) 的访问，使得内核能够加载第一个用户进程和核心服务。

- **内存管理 (Memory Management):** 位于 `kernel/src/memory` 目录，包含了物理内存分配器（如伙伴系统）、虚拟内存管理、内存映射 (mmap) 管理和 DMA (直接内存访问) 等功能。它确保系统能够高效、安全地管理和分配内存资源。

- **进程管理 (Process Management):** 位于 `kernel/src/process` 目录，处理进程和任务的生命周期，包括进程的创建、销毁、状态切换以及系统调用接口的实现。

- **安全与能力 (Security & Capabilities):** 位于 `kernel/src/security` 目录，实现了基于能力 (Capability) 的安全模型。它通过细粒度的权限控制，限制进程对系统资源的访问，从而增强系统的整体安全性。

- **同步原语 (Synchronization):** 虽然核心实现已迁移至 `shared` 库，但内核中依然会使用这些同步原语来保护共享数据结构，防止竞态条件。例如 `Mutex` 和 `RwLock`。

## 内核模块文档

为了更好地理解内核的内部工作原理，我们为每个核心模块提供了详细的文档。

-   [架构抽象层 (Architecture Abstraction)](./arch/mod.md)
-   [核心原语 (Core Primitives)](./core/mod.md)
-   [驱动程序 (Drivers)](./drivers/mod.md)
-   [错误处理 (Error Handling)](./error/mod.md)
-   [IPC 服务 (IPC Services)](./ipc_services/mod.md)
-   [加载器 (Loader)](./loader/mod.md)
-   [内存管理 (Memory Management)](./memory/mod.md)
-   [进程管理 (Process Management)](./process/mod.md)
-   [安全与能力 (Security & Capabilities)](./security/mod.md)
-   [同步原语 (Synchronization)](./sync/mod.md)