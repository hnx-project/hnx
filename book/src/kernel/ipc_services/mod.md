# IPC 服务 (IPC Services)

HNX 内核的 `ipc_services` 模块 (`kernel/src/ipc_services`) 是连接内核与用户空间服务的关键桥梁。它实现了 IPC 委托框架，使得内核能够将复杂的系统级操作安全、高效地委托给用户空间的服务来处理。这种设计是 HNX 微内核架构的基石，确保了内核的精简性和大部分系统功能的模块化。

## 设计理念

-   **内核精简:** 内核只处理最基本的 IPC 消息路由，将具体业务逻辑下放到用户空间服务。
-   **服务委托:** 内核在收到特定的系统调用或硬件事件时，不是自己处理，而是将请求封装成 IPC 消息，发送给相应的用户空间服务进行处理。
-   **类型安全通信:** 通过 `protocol.rs` 定义了内核与服务之间通信的消息结构和协议，确保数据交换的类型安全和一致性。
-   **能力授权:** IPC 消息的发送和接收受到能力 (Capability) 机制的保护，确保只有具备相应权限的服务才能进行通信和操作。

## 核心组件

`ipc_services` 模块包含以下关键文件和概念：

-   **`delegate.rs`:** 实现了 IPC 委托的核心逻辑。当内核需要用户空间服务执行某项任务时，`delegate.rs` 中的函数会构建 IPC 消息并将其发送到目标服务，然后等待服务的响应。
    -   例如，当用户程序请求创建一个新进程时，内核不会直接处理，而是通过 `delegate.rs` 将请求委托给 `procmgr-service` (进程管理服务)。

-   **`endpoints.rs`:** 定义了内核中 IPC 端点的管理。IPC 端点是消息发送和接收的逻辑地址。该文件可能包含端点的注册、查找和生命周期管理。

-   **`protocol.rs`:** 定义了内核与用户空间服务之间通信的 IPC 消息协议。这包括消息的类型、操作码、数据载荷结构等。通过统一的协议，确保了内核和服务之间通信的稳定性和可互操作性。
    -   例如，可能定义了 `SpawnService`、`CreateProcess` 等操作类型，以及它们所需参数的结构。

-   **`IPC_DELEGATION_FRAMEWORK.md`:** (此文档可能在项目根目录或其他位置，但概念上属于本模块) 详细描述了整个 IPC 委托框架的运作机制、设计决策和使用指南。它是理解 HNX 服务化架构的关键文档。

## IPC 委托框架的工作流

1.  **用户空间发起系统调用:** 应用程序通过系统调用（如 `sys_spawn_service`）请求内核执行某项操作。
2.  **内核拦截并识别:** 内核捕获系统调用，并识别出该操作需要委托给用户空间服务处理。
3.  **封装 IPC 消息:** `ipc_services` 模块（通过 `delegate.rs`）构建一个 IPC 消息，其中包含系统调用的相关信息和参数。
4.  **发送到服务端点:** 消息被发送到负责处理该操作的用户空间服务对应的 IPC 端点。
5.  **服务处理请求:** 用户空间服务接收并解析 IPC 消息，执行相应的业务逻辑（例如，`loader-service` 负责加载新的可执行文件）。
6.  **服务返回结果:** 服务将操作结果封装成 IPC 响应消息，通过 IPC 机制发送回内核。
7.  **内核解封并返回:** 内核接收响应，将其转换回系统调用的返回值格式，并返回给原始的应用程序。

## 模块间交互

-   **与 `core` 模块 (IPC 部分):** `ipc_services` 依赖于 `core` 模块提供的底层 IPC 机制（如消息的传输、端点查找）。
-   **与 `process` 模块:** 在委托创建新进程等操作时，会与 `process` 模块进行交互。
-   **与 `security` 模块:** 委托框架严格遵循能力模型，对 IPC 通信进行权限检查。

`ipc_services` 模块是实现 HNX 微内核灵活性的关键，它允许系统功能在用户空间以服务形式存在，降低了内核的复杂性，并提高了整个系统的可维护性和健壮性。