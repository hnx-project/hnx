# 进程管理 (Process Management)

HNX 内核的 `process` 模块 (`kernel/src/process`) 负责管理系统中的所有执行单元，即进程和任务。它是实现多任务操作系统的核心，提供了创建、调度、管理和销毁进程和任务的机制。

## 核心概念

### 进程 (Process)

在 HNX 中，进程是资源分配的基本单位。每个进程都拥有独立的虚拟地址空间、文件描述符表（如果实现）以及一组能力 (Capabilities)。用户空间服务和应用程序都作为独立的进程运行。

-   **进程控制块 (PCB - Process Control Block):** 存储了进程的所有关键信息，包括进程 ID (PID)、状态、寄存器上下文、页表指针、内存区域描述符、以及其持有的能力等。PCB 是进程在内核中的完整抽象。

### 任务 (Task)

任务是调度器进行调度的基本单位。在一个进程内部可以有一个或多个任务（线程），它们共享进程的资源，但拥有独立的执行上下文（如程序计数器、栈指针和寄存器）。

-   **任务上下文:** 包括通用寄存器、程序计数器、栈指针等，是任务状态的完整快照，用于任务切换时的保存和恢复。

## 模块结构与功能

-   **`mod.rs`:** 包含进程和任务管理的核心数据结构定义、状态转换逻辑以及公共接口。它协调各个子模块，提供一个统一的进程管理视图。

-   **`spawn.rs`:** 实现了进程和任务的创建（spawn）机制。这包括：
    -   **`spawn_process`:** 创建一个新的空进程，为其分配 PID 和初始资源（如页表）。
    -   **`spawn_task`:** 在现有进程中创建一个新的任务（线程），设置其执行入口点和栈。
    -   这些函数会与 `memory` 模块交互来分配内存，与 `arch` 模块交互来设置初始上下文，并与 `security` 模块交互来分配初始能力。

-   **`syscall/`:** 包含了与进程管理相关的系统调用接口 (`kernel/src/process/syscall/mod.rs` 及其相关文件)。当用户程序需要创建进程、获取进程信息、或者执行其他进程相关操作时，会通过这些系统调用进入内核。
    -   **`HNX_SYS_PROCESS_CREATE` (0x0101):** 创建一个空进程的系统调用接口。
    -   **`HNX_SYS_SPAWN_SERVICE` (0x0103):** 从 initrd 加载并启动一个服务的系统调用接口。

-   **`task/`:** 专注于任务（线程）的管理。可能包含任务状态的定义、任务切换逻辑、以及与调度器 (`core/scheduler`) 的接口。

## 进程生命周期

一个进程的生命周期通常包括：

1.  **创建 (Created):** 通过 `spawn_process` 或 `sys_spawn_service` 创建，分配 PID 和基本资源。
2.  **就绪 (Ready):** 任务已准备好运行，被添加到调度器的就绪队列。
3.  **运行 (Running):** 任务正在 CPU 上执行。
4.  **阻塞 (Blocked):** 任务等待某个事件（如 IPC 消息、I/O 完成）发生。
5.  **终止 (Terminated):** 进程完成执行或被异常终止，其资源被回收。

## 模块间交互

-   **与 `core` 模块:** `process` 模块创建的任务会被 `core/scheduler` 调度执行；进程间的通信通过 `core/ipc` 实现。
-   **与 `memory` 模块:** 进程的虚拟地址空间和页表由 `memory` 模块管理。
-   **与 `loader` 模块:** `loader` 模块负责初始进程的启动，并利用 `process` 模块的功能来创建这些进程。
-   **与 `security` 模块:** 进程被赋予特定的能力，`security` 模块确保进程操作的权限正确性。

`process` 模块是 HNX 实现多任务环境的基石，其设计和实现直接影响着系统的并发性、隔离性和整体性能。