# 内存管理 (Memory Management)

HNX 内核的 `memory` 模块 (`kernel/src/memory`) 负责操作系统中最关键的资源之一：内存。它管理着物理内存的分配与释放，以及为每个进程提供独立的虚拟地址空间，确保系统能够高效、安全且隔离地运行多个任务。

## 内存管理概述

内存管理的主要目标是：

-   **抽象化:** 隐藏物理内存的复杂性，为程序提供简单、一致的内存视图。
-   **隔离性:** 确保不同进程的内存空间相互独立，防止相互干扰，增强系统稳定性。
-   **保护:** 通过硬件（如 MMU）强制执行内存访问权限，防止非法内存访问。
-   **高效利用:** 有效地分配和回收内存，减少碎片，提高内存利用率。

## 核心概念

### 物理内存 (Physical Memory)

物理内存是计算机系统中实际安装的 RAM。HNX 内核通过物理内存管理器来跟踪和分配这些原始内存资源。

-   **伙伴系统 (Buddy Allocator):** 位于 `buddy_allocator.rs`。这是一种高效的物理内存分配算法，能够将物理内存划分为不同大小的块，并利用合并机制减少外部碎片。它是 HNX 物理页框分配的基础。
-   **Slab 分配器 (Slab Allocator):** 位于 `slab_allocator.rs`。这是一种用于分配固定大小的小对象（如内核数据结构）的内存管理机制。它可以减少内部碎片和分配开销，提高缓存利用率。
-   **DMA (Direct Memory Access):** 位于 `dma.rs`。允许硬件设备直接读写内存，而无需 CPU 的介入。这对于高性能 I/O 操作至关重要，`dma.rs` 可能提供 DMA 缓冲区管理和与设备交互的接口。

### 虚拟内存 (Virtual Memory)

虚拟内存为每个进程提供了一个连续、独立的地址空间，与实际的物理内存地址解耦。所有用户进程都在其自己的虚拟地址空间中运行。

-   **页表 (Page Tables):** 虚拟内存通过页表机制映射到物理内存。每个进程拥有独立的页表，实现用户/内核空间分离。
-   **VMA (Virtual Memory Area) 跟踪:** 位于 `mmap_manager.rs`。它管理着进程虚拟地址空间中的区域，每个区域代表一段具有特定属性（如读/写权限、可执行性）的内存。ELF 加载器会使用 VMA 机制来管理程序代码和数据段的映射。
-   **虚拟内存子系统 (`virtual_/.rs`):** 处理页表的创建、修改和销毁，以及虚拟地址到物理地址的转换。
-   **内存保护 (`protection/.rs`):** 管理内存区域的访问权限，如读、写、执行，并通过硬件 MMU 实现这些保护策略。

## 模块间交互

-   **与 `arch` 模块:** 内存管理高度依赖于架构特定的 MMU 硬件特性，`arch` 模块提供底层 MMU 操作接口。
-   **与 `process` 模块:** 每个进程都需要独立的虚拟地址空间和页表，`process` 模块会调用 `memory` 模块的功能来创建和管理这些资源。
-   **与 `loader` 模块:** `loader` 模块在加载 ELF 文件时，需要 `memory` 模块来创建 VMA 并将文件内容映射到进程的虚拟地址空间。

`memory` 模块的健壮性和效率直接影响着 HNX 系统的整体性能和安全性。理解其内部机制对于开发高效、稳定的内核组件至关重要。