# 加载器 (Kernel Loader)

HNX 内核的 `loader` 模块 (`kernel/src/loader`) 负责系统的引导过程，以及用户空间第一个进程 (init) 和核心服务的启动。它是连接固件/引导加载器与内核运行环境，以及内核与用户空间服务之间的关键环节。

## 引导过程概述

1.  **固件/引导加载器:** 硬件通电后，首先执行固件（如 UEFI 或 BIOS）或专用引导加载器。
2.  **内核加载:** 引导加载器将 HNX 内核镜像和初始根文件系统 (initrd) 加载到内存中的指定位置。
3.  **内核启动:** 内核开始执行，完成自身的初始化（包括内存管理、IPC、调度等）。
4.  **Initrd 访问:** 内核通过 `initrd.rs` 提供的功能访问加载到内存中的 initrd 内容。
5.  **启动 Init 进程:** 内核从 initrd 中找到 `/init` 可执行文件，并使用 `bootstrap_elf.rs` 中的极简 ELF 加载器将其加载并启动为用户空间的第一个进程 (PID 1)。
6.  **服务链启动:** Init 进程随后负责从 initrd 中的 `/bin/` 目录加载和启动其他核心用户空间服务（如 `loader-service`, `ipcrouter-service` 等）。

## 核心组件

-   **`initrd.rs`:** 负责管理初始根文件系统 (Initial RAM Disk) 的访问。Initrd 是一个包含必要的用户空间程序和配置文件的内存文件系统，内核在启动初期需要它来启动用户空间环境。
    -   它提供了解析 initrd 格式（通常是 `cpio` 归档）的功能，使得内核能够定位并读取其中的文件。
    -   当前 HNX 默认使用 gzip 压缩的 initrd，但内核尚未完全支持解压功能，这意味着目前需要未压缩的 initrd 或由外部工具预先解压。

-   **`bootstrap_elf.rs`:** 一个精简的 ELF (Executable and Linkable Format) 加载器。它专门用于加载用户空间第一个进程 (`/init`)。为了保持内核的精简性，这个加载器功能有限，只满足启动 `init` 进程所需的最低要求，而不是一个完整的通用 ELF 加载器。
    -   它负责解析 ELF 文件的头部信息、加载程序段到进程的虚拟地址空间，并设置进程的初始执行上下文（如入口点、栈指针）。

## Initrd 创建

HNX 的构建系统会自动创建两种类型的 initrd：

-   **简单 initrd (`simple-image`):** 仅包含 `init` 进程和核心系统服务（如 `loader-service`, `ipcrouter-service`）。主要用于快速开发和测试。
-   **完整 initrd:** 包含更完整的目录结构和可能的用户应用程序，用于更全面的系统仿真和功能测试。

## 服务加载机制

用户空间服务的加载并非由内核直接完成，而是通过 `sys_spawn_service` 系统调用（该系统调用内部会委托给 `loader-service` 处理）从 initrd 的 `/bin/` 目录动态加载。这种机制实现了服务的高度模块化和按需加载。

`loader` 模块在 HNX 的生命周期中扮演着至关重要的角色，它定义了操作系统从硬件启动到用户空间环境准备就绪的整个流程。