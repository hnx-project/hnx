# 核心原语 (Core Primitives)

HNX 内核的 `core` 模块 (`kernel/src/core`) 封装了操作系统最基础且不可或缺的功能，是整个微内核的核心。它主要负责实现进程间通信 (IPC) 机制和任务调度器，这两者共同构成了 HNX 多任务和微服务架构的基石。

## 进程间通信 (IPC)

IPC 是微内核架构中各个组件（包括内核、用户空间服务和应用程序）之间进行数据交换和协调的唯一途径。HNX 的 IPC 系统设计注重效率和安全性，支持同步和异步通信模式。

-   **设计理念:**
    -   **基于消息:** 所有通信都通过发送和接收消息进行。
    -   **能力授权:** 通过能力 (Capability) 机制控制 IPC 端点的访问权限，增强安全性。
    -   **同步与异步:** 提供灵活的 API，支持需要即时响应的同步调用和非阻塞的异步操作。

-   **核心组件 (`kernel/src/core/ipc`):**
    -   **端点 (Endpoints):** 消息发送和接收的抽象实体，每个服务或进程通常拥有一个或多个端点。
    -   **消息 (`IpcMessage`):** 定义了通信数据的结构，包含操作码、参数和可选的数据缓冲区。
    -   **IPC 机制:** 实现了消息的排队、转发、等待和唤醒机制，确保消息在不同地址空间之间的正确传递。
    -   **系统调用接口:** 提供 `endpoint_send_sync`、`endpoint_recv_sync` 等系统调用，供用户空间进行 IPC 操作。

## 调度器 (Scheduler)

调度器是操作系统的心脏，负责管理系统中所有可运行任务的执行顺序和时间片分配。HNX 的调度器旨在提供一个公平、响应迅速且可预测的任务执行环境。

-   **设计理念:**
    -   **抢占式调度:** 调度器可以中断当前正在运行的任务，将 CPU 分配给更高优先级的任务。
    -   **基于优先级:** 任务可以被赋予不同的优先级，调度器会优先执行高优先级任务。
    -   **时间片轮转:** 在相同优先级的任务之间，采用时间片轮转机制，确保每个任务都有机会执行，避免饥饿。

-   **核心组件 (`kernel/src/core/scheduler`):**
    -   **任务 (`Task`):** 调度器的基本调度单位，包含任务的上下文（寄存器状态）、优先级和状态。
    -   **就绪队列 (Ready Queue):** 维护所有处于可运行状态的任务列表，调度器从中选择下一个要执行的任务。
    -   **上下文切换:** 实现了高效的 CPU 状态保存和恢复机制，确保任务切换的原子性和低开销。
    -   **调度算法:** 当前可能采用简单的轮询或优先级调度算法，为后续更复杂的调度策略奠定基础。

## 模块间交互

`core` 模块与其他内核组件紧密协作：

-   **与 `arch` 模块:** 调度器在进行上下文切换时，需要调用 `arch` 模块提供的架构特定函数来保存和恢复 CPU 寄存器状态。IPC 机制也依赖 `arch` 提供的系统调用接口。
-   **与 `memory` 模块:** 调度器需要 `memory` 模块提供的页表管理功能，以在任务切换时切换地址空间。IPC 在传递数据时可能需要跨越不同的虚拟地址空间，这也需要内存管理的支持。
-   **与 `process` 模块:** `process` 模块负责创建和管理进程，而这些进程的实际调度和通信则由 `core` 模块提供支持。

`core` 模块作为 HNX 内核的基石，其健壮性和效率直接关系到整个系统的性能和可靠性。对这两个核心原语的深入理解，是理解 HNX 工作原理的关键。