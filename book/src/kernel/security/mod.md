# 安全与能力 (Security & Capabilities)

HNX 内核的 `security` 模块 (`kernel/src/security`) 是实现系统安全基石的关键组成部分。它主要通过**能力 (Capability)** 机制，提供细粒度的访问控制，确保每个进程或服务仅能执行其被明确授权的操作，从而最大程度地降低潜在的安全风险。

## 能力 (Capability) 机制

能力是一种安全令牌，代表了对系统资源或操作的特定权限。在 HNX 中，能力不是全局的，而是与特定的进程或 IPC 端点关联。一个进程只有持有相应的能力，才能执行某种特权操作或访问受保护的资源。

-   **细粒度控制:** 与传统的基于用户/组权限的模型不同，能力提供了更加精细的控制。例如，可以授予一个进程仅创建新进程的能力，而不能访问文件系统。
-   **最小权限原则:** 系统严格遵循最小权限原则。进程在创建时只被赋予其完成任务所必需的最小能力集。任何额外的权限都需要显式地获取。
-   **可传递性:** 能力可以安全地在进程之间传递，例如父进程可以将其部分能力授予子进程，或一个服务可以将操作能力传递给另一个服务。
-   **不可伪造性:** 能力由内核管理和验证，用户空间无法伪造或篡改能力。

## 核心组件 (`kernel/src/security`)

-   **`capability.rs`:** 核心实现文件，定义了 `Capability` 的数据结构、创建、验证、销毁和传递逻辑。它可能包括：
    -   **能力类型:** 定义不同类型的能力，例如 IPC 能力、内存管理能力、设备访问能力等。
    -   **能力管理:** 内核如何分配唯一的 `Capability ID`，以及如何维护全局的能力表。
    -   **权限检查:** 在执行敏感操作前，内核会通过此模块验证当前进程是否持有相应的能力。

-   **`test.rs`:** 包含了针对能力机制的单元测试和集成测试，用于验证能力分配、传递和权限检查的正确性。

## 安全模型的工作流

1.  **能力创建:** 在内核初始化或特权进程创建新资源时，内核会生成相应的能力，并将其与资源所有者关联。
2.  **能力授予/传递:** 进程可以通过特定的系统调用或 IPC 机制，将自己持有的部分能力授予其他进程或服务。
3.  **权限检查:** 当进程尝试执行一个特权操作时（例如，通过系统调用），内核会首先检查该进程是否持有执行此操作所需的相应能力。
4.  **操作执行或拒绝:** 如果进程持有能力，操作被允许执行；否则，操作将被拒绝，并返回权限错误。

## 模块间交互

-   **与 `process` 模块:** 进程在创建时获得初始能力；进程的生命周期管理也需要考虑其持有的能力。
-   **与 `ipc_services` 模块:** IPC 消息的发送和接收，以及 IPC 端点的创建，都受到能力机制的严格控制。
-   **与 `memory` 模块:** 访问特定的内存区域（如设备内存）可能需要相应的内存访问能力。

通过能力机制，HNX 建立了一个强大且灵活的安全模型，使得系统能够有效抵御恶意攻击，并为构建高度可信赖的微内核系统提供了坚实的基础。