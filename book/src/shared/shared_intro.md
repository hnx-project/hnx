# 共享库 (Shared Library)

HNX 的 `shared` 库是一个独立的核心 crate，位于项目根目录的 `shared/` 文件夹下。它的主要目的是提供一套可以在 HNX 内核和所有用户空间组件（如服务和应用程序）之间共享的通用代码、数据结构和抽象。通过这种方式，`shared` 库极大地促进了代码复用，减少了重复实现，并确保了系统不同部分之间的一致性。

## 设计目标

-   **代码复用:** 避免在内核和用户空间之间复制代码，提高开发效率。
-   **接口一致性:** 为系统级抽象（如 ABI、IPC 协议）提供统一的定义，确保内核与用户空间之间以及不同用户空间组件之间的兼容性。
-   **最小依赖:** `shared` 库本身应尽量减少对其他复杂库的依赖，以保持其轻量级和通用性。
-   **`no_std` 兼容:** 库中的大部分代码被设计为在 `no_std` 环境下运行，这对于嵌入式系统和操作系统内核开发至关重要。

## 核心模块

`shared` 库包含以下关键模块：

### ABI 定义 (`abi/`)

`shared/src/abi` 模块定义了 HNX 的应用程序二进制接口 (ABI)。这是内核与用户空间以及不同用户空间组件之间通信的契约。它确保了跨编译器的兼容性和系统调用的正确性。

-   **`mod.rs`:** 导出 ABI 定义的主模块。
-   **`syscalls.rs`:** 定义了所有 HNX 系统调用的编号、参数和返回值结构。这是用户程序与内核交互的唯一接口。
-   **`types.rs`:** 包含了系统范围内使用的基本数据类型定义，例如进程 ID (PID)、句柄、能力类型等。
-   **`errors.rs`:** 定义了系统调用可能返回的错误类型，提供统一的错误码和错误信息。
-   **`constants.rs`:** 包含了系统范围内的常量，如内存页大小、最大进程数、IPC 消息缓冲区大小等。

### 集合 (`collections/`)

`shared/src/collections` 模块提供了在 `no_std` 环境下可用的基本数据结构。这些数据结构通常是 `heapless` 或基于固定大小数组的实现，以避免在内核或早期用户空间阶段引入动态内存分配的复杂性。

-   例如，可能包含 `Vec`、`HashMap` 等的 `heapless` 版本，或针对特定需求优化的数据结构。

### 同步原语 (`sync/`)

`shared/src/sync` 模块包含了 HNX 的核心同步原语，例如 `Mutex` (互斥锁)、`Semaphore` (信号量)、`Condvar` (条件变量) 和 `RwLock` (读写锁)。这些原语是构建并发系统和保护共享数据所必需的，它们被设计为 `no_std` 兼容，并可以在内核和用户空间安全使用。

-   **详细文档:** 更多关于同步原语的详细信息，请参考 [HNX 同步原语](./sync/mod.md)。

## 使用方式

任何需要访问 HNX 系统 API、通用数据类型或同步机制的 crate，都可以将 `shared` 库作为依赖项引入。例如，内核需要 `shared::abi::syscalls` 来处理系统调用，用户空间服务需要 `shared::sync::Mutex` 来保护共享数据。

通过 `shared` 库，HNX 实现了高效的模块化和一致性，是整个操作系统架构中不可或缺的一部分。